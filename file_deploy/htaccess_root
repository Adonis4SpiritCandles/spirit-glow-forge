# === Root: Pretty URL per SPA in /spiritcandles + convivenza WordPress ===
Options -MultiViews

<IfModule mod_rewrite.c>
  RewriteEngine On

  # 0) HTTPS sempre
  RewriteCond %{HTTPS} !=on
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

  # 1) Se file o dir esiste, passa (evita di toccare asset reali e file WP)
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule - - [L]

  # 2) LASCIA PASSARE WordPress “core” (se presente)
  RewriteRule ^(wp-admin|wp-includes|wp-content|wp-json)(/|$) - [L]
  RewriteRule ^(wp-login\.php|wp-cron\.php|xmlrpc\.php)(/|$) - [L]

  # 3) LASCIA PASSARE TUTTI GLI ASSET DELLA SPA
  RewriteRule ^spiritcandles/(assets|images|img|videos|media|fonts|static)/ - [L]
  RewriteRule ^spiritcandles/(favicon\.(ico|png)|robots\.txt|sitemap\.xml)$ - [L]

  # 4) Mappature comode per path assoluti "brevi"
  RewriteRule ^videos/(.*)$ /spiritcandles/videos/$1 [L]
  RewriteRule ^images/(.*)$ /spiritcandles/images/$1 [L]
  RewriteRule ^assets/(.*)$ /spiritcandles/assets/$1 [L]
  RewriteRule ^fonts/(.*)$  /spiritcandles/fonts/$1  [L]

  # 5) Blog WP sotto /blog/ (se lo usi)
  RewriteRule ^blog/ - [L]

  # 6) INTERCETTA CRAWLER SOCIAL MEDIA per SEO Meta Tags dinamici
  # Reindirizza i crawler all'Edge Function Supabase per meta tags dinamici
  # Questa regola deve essere PRIMA del catch-all SPA
  # Nota: REQUEST_URI per https://spirit-candle.com/about è /about (non /spiritcandles/about)
  # Per LiteSpeed/Hostinger, usa redirect 302 (i crawler lo seguono e ottengono l'HTML corretto)
  # IMPORTANTE: Tutte le RewriteCond devono essere ripetute per ogni RewriteRule!
  
  # Abilita mod_proxy e mod_proxy_http per proxy pass (se disponibili)
  # Se non disponibili, queste righe verranno ignorate e useremo il redirect
  <IfModule mod_proxy.c>
    <IfModule mod_proxy_http.c>
      ProxyPreserveHost On
      ProxyPassReverse / https://fhtuqmdlgzmpsbflxhra.supabase.co/
    </IfModule>
  </IfModule>
  
  # Homepage per crawler - PROXY PASS (mantiene URL originale)
  # Se mod_proxy non è disponibile, fallback a redirect 302
  RewriteCond %{HTTP_USER_AGENT} (facebookexternalhit|Facebot|twitterbot|linkedinbot|slackbot|telegrambot|whatsapp|pinterest|discordbot|googlebot|bingbot|baiduspider|yandexbot) [NC]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_URI} !^/(spiritcandles|wordpress|wp-admin|wp-includes|wp-content|ImageFiles|OLD_spirit-candle_OLD) [NC]
  RewriteCond %{REQUEST_URI} !\.(js|css|png|jpg|jpeg|gif|svg|webp|ico|woff|woff2|ttf|eot|json|xml|txt)$ [NC]
  RewriteCond %{REQUEST_URI} ^/$
  RewriteRule ^$ https://fhtuqmdlgzmpsbflxhra.supabase.co/functions/v1/serve-seo-meta?path=/ [P,L]
  
  # Altri path per crawler - PROXY PASS (mantiene URL originale)
  # Se mod_proxy non è disponibile, fallback a redirect 302
  RewriteCond %{HTTP_USER_AGENT} (facebookexternalhit|Facebot|twitterbot|linkedinbot|slackbot|telegrambot|whatsapp|pinterest|discordbot|googlebot|bingbot|baiduspider|yandexbot) [NC]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_URI} !^/(spiritcandles|wordpress|wp-admin|wp-includes|wp-content|ImageFiles|OLD_spirit-candle_OLD) [NC]
  RewriteCond %{REQUEST_URI} !\.(js|css|png|jpg|jpeg|gif|svg|webp|ico|woff|woff2|ttf|eot|json|xml|txt)$ [NC]
  RewriteCond %{REQUEST_URI} !^/$
  RewriteRule ^(.*)$ https://fhtuqmdlgzmpsbflxhra.supabase.co/functions/v1/serve-seo-meta?path=%{REQUEST_URI} [P,L]

  # 7) CATCH-ALL SPA (URL belli: nessun /spiritcandles visibile)
  # Solo per utenti normali (non crawler)
  RewriteRule ^$                 /spiritcandles/index.html [L]
  RewriteRule ^(?!blog/).+       /spiritcandles/index.html [L]
</IfModule>

# BEGIN LSCACHE (lascia invariato)
<IfModule LiteSpeed>
RewriteEngine on
CacheLookup on
RewriteRule .* - [E=Cache-Control:no-autoflush]
RewriteRule litespeed/debug/.*\.log$ - [F,L]
RewriteRule \.litespeed_conf\.dat - [F,L]
### marker ASYNC start ###
RewriteCond %{REQUEST_URI} /wp-admin/admin-ajax\.php
RewriteCond %{QUERY_STRING} action=async_litespeed
RewriteRule .* - [E=noabort:1]
### marker ASYNC end ###
### marker DROPQS start ###
CacheKeyModify -qs:fbclid
CacheKeyModify -qs:gclid
CacheKeyModify -qs:utm*
CacheKeyModify -qs:_ga
### marker DROPQS end ###
</IfModule>